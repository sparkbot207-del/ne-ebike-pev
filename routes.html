<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Explore curated e-bike routes across New England with maps, trail details, and 7,000+ charging stations. Plan your next electric bike adventure.">
    <title>E-Bike Routes & Trails | New England E-Bike Hub</title>
    <meta name="description" content="Best e-bike friendly trails and routes across New England. Interactive map of rail trails in Vermont, Maine, New Hampshire, Massachusetts, Connecticut, and Rhode Island.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Routes page specific styles */
        #trail-map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .map-section {
            padding: 2rem 0;
        }
        
        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.vt { background: #2ecc71; }
        .legend-dot.me { background: #e74c3c; }
        .legend-dot.nh { background: #9b59b6; }
        .legend-dot.ma { background: #3498db; }
        .legend-dot.ct { background: #f39c12; }
        .legend-dot.ri { background: #1abc9c; }
        
        /* Map Controls */
        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .map-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .map-toggle:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .map-toggle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .map-toggle input {
            display: none;
        }
        
        .charging-count {
            font-size: 0.75rem;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* Enhanced Popup Styles */
        .leaflet-popup-content {
            min-width: 200px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        
        .popup-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .popup-btn-nav {
            background: #4285f4;
            color: white;
        }
        
        .popup-btn-nav:hover {
            background: #3367d6;
        }
        
        .popup-btn-web {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .popup-btn-web:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .popup-btn-gpx {
            background: #10b981;
            color: white;
        }
        
        .popup-btn-gpx:hover {
            background: #059669;
        }
        
        /* Charging station popup */
        .charging-popup h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        
        .charging-popup .charging-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .charging-popup .charging-type.j1772 {
            background: #f59e0b;
            color: #000;
        }
        
        .charging-popup .charging-type.nema {
            background: #10b981;
            color: white;
        }
        
        .charging-popup .charging-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            margin: 0.25rem 0;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 12px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .trails-section {
            padding: 3rem 0;
        }
        
        .state-group {
            margin-bottom: 3rem;
        }
        
        .state-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--accent);
            color: #ffffff;
        }
        
        .trail-count-badge {
            font-size: 1rem;
            color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(16, 185, 129, 0.3);
            margin-left: 0.5rem;
        }
        
        .trail-count-badge:hover {
            background: rgba(16, 185, 129, 0.3);
            color: #fff;
        }
        
        /* Trail List Modal */
        .trail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .trail-modal.active {
            display: block;
        }
        
        .trail-modal-content {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a2e;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .trail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
        }
        
        .trail-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .trail-modal-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .trail-modal-close:hover {
            color: #fff;
        }
        
        .trail-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .trail-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .trail-list-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .trail-list-name {
            font-weight: 600;
            color: #fff;
            flex: 1;
            min-width: 200px;
        }
        
        .trail-list-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .trail-list-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .trail-list-actions a {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            text-decoration: none;
            color: #fff;
        }
        
        .trail-list-actions .btn-info {
            background: #3b82f6;
        }
        
        .trail-list-actions .btn-nav {
            background: #10b981;
        }
        
        .trail-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .trail-card {
            background: var(--card-bg, #1a1a2e);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .trail-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        
        .trail-card.top-pick {
            border-color: var(--accent);
            position: relative;
        }
        
        .trail-card.top-pick::before {
            content: "‚≠ê TOP PICK";
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--accent);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .trail-card h3 {
            color: #fff;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
        }
        
        .trail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        
        .trail-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .trail-card p {
            color: rgba(255,255,255,0.8);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        
        .trail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .trail-tag {
            background: rgba(255,255,255,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
        }
        
        .resources-section {
            padding: 3rem 0;
            background: rgba(255,255,255,0.02);
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .resource-link {
            display: block;
            background: var(--card-bg, #1a1a2e);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .resource-link:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .resource-link h3 {
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .resource-link p {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }
        
        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            background: #1a1a2e;
            color: #fff;
            border-radius: 8px;
        }
        
        .leaflet-popup-tip {
            background: #1a1a2e;
        }
        
        .leaflet-popup-content h3 {
            margin: 0 0 0.5rem 0;
            color: #fff;
        }
        
        .leaflet-popup-content p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }
        
        .popup-distance {
            color: var(--accent) !important;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            #trail-map {
                height: 350px;
            }
            
            .trail-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav scrolled">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">‚ö° New England E-Bike and PEV</a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="laws.html">Laws</a>
                <a href="routes.html" class="active">Routes</a>
                
                <a href="planner.html">Ride Planner</a>
                <a href="shops.html">E-Bike &amp; PEV Shops</a>
                <a href="https://www.facebook.com/groups/573295111141320/" target="_blank" class="nav-cta">Join us on Facebook</a>
            </div>
            <button class="nav-toggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Header -->
    <header class="page-header">
        <div class="container">
            <h1>üó∫Ô∏è Routes & Trails</h1>
            <p>Explore the best e-bike friendly trails across New England</p>
        </div>
    </header>

    <!-- Interactive Map Section -->
    <section class="map-section">
        <div class="container">
            <h2 class="section-title">Interactive Trail Map</h2>
            <p style="text-align: center; color: rgba(255,255,255,0.7); margin-bottom: 1rem;">Click markers for trail details ‚Ä¢ Toggle charging stations below</p>
            
            <!-- Map Layer Controls -->
            <div class="map-controls">
                <label class="map-toggle active">
                    <input type="checkbox" id="toggle-trails" checked>
                    üö¥ Trails <span class="charging-count" id="trail-count">...</span>
                </label>
                <label class="map-toggle" id="charging-toggle">
                    <input type="checkbox" id="toggle-charging">
                    ‚ö° Charging Stations <span class="charging-count" id="charging-count">0</span>
                </label>
            </div>
            
            <!-- Trail Search Box -->
            <div id="trail-search-container" style="margin-bottom: 1rem;">
                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <input type="text" id="trail-search" placeholder="üîç Search by trail name, city, or address..." 
                           style="padding: 0.6rem 1rem; border-radius: 25px; border: 1px solid rgba(16,185,129,0.3); 
                                  background: rgba(16,185,129,0.1); color: white; width: 300px; font-size: 0.9rem;">
                    <button id="trail-search-btn" style="padding: 0.6rem 1.2rem; border-radius: 25px; border: none; 
                                                    background: #10b981; color: white; cursor: pointer; font-weight: 600;">
                        Search
                    </button>
                    <button id="trail-clear-search" style="padding: 0.6rem 1rem; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: transparent; color: rgba(255,255,255,0.8); cursor: pointer; display: none;">
                        Clear
                    </button>
                </div>
                <p id="trail-search-results" style="text-align: center; color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-top: 0.5rem;"></p>
            </div>
            
            <!-- Charging Search Box (shown when charging enabled) -->
            <div id="search-container" style="display:none; margin-bottom: 1rem;">
                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <input type="text" id="charging-search" placeholder="üîç Search by name, city, or address..." 
                           style="padding: 0.6rem 1rem; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); 
                                  background: rgba(255,255,255,0.1); color: white; width: 300px; font-size: 0.9rem;">
                    <button id="search-btn" style="padding: 0.6rem 1.2rem; border-radius: 25px; border: none; 
                                                    background: var(--primary); color: white; cursor: pointer; font-weight: 600;">
                        Search
                    </button>
                    <button id="clear-search" style="padding: 0.6rem 1rem; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: transparent; color: rgba(255,255,255,0.8); cursor: pointer; display: none;">
                        Clear
                    </button>
                </div>
                <p id="search-results" style="text-align: center; color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 0.5rem;"></p>
            </div>
            
            <div id="trail-map" style="position: relative;">
                <div class="loading-overlay" id="map-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="map-legend">
                <div class="legend-item"><span class="legend-dot ct"></span> Connecticut</div>
                <div class="legend-item"><span class="legend-dot me"></span> Maine</div>
                <div class="legend-item"><span class="legend-dot ma"></span> Massachusetts</div>
                <div class="legend-item"><span class="legend-dot nh"></span> New Hampshire</div>
                <div class="legend-item"><span class="legend-dot ri"></span> Rhode Island</div>
                <div class="legend-item"><span class="legend-dot vt"></span> Vermont</div>
            </div>
        </div>
    </section>

    <!-- Trails by State -->
    <section class="trails-section">
        <div class="container">
            
            <div class="state-group" id="connecticut">
                <h2 class="state-title">üèõÔ∏è Connecticut</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

            <div class="state-group" id="maine">
                <h2 class="state-title">ü¶û Maine</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

            <div class="state-group" id="massachusetts">
                <h2 class="state-title">üèñÔ∏è Massachusetts</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

            <div class="state-group" id="new-hampshire">
                <h2 class="state-title">‚õ∞Ô∏è New Hampshire</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

            <div class="state-group" id="rhode-island">
                <h2 class="state-title">üêö Rhode Island</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

            <div class="state-group" id="vermont">
                <h2 class="state-title">üèîÔ∏è Vermont</h2>
                <div class="trail-cards">
                    <!-- Dynamically loaded -->
                </div>
            </div>

        </div>
    </section>

    <!-- Resources Section -->
    <section class="resources-section">
        <div class="container">
            <h2 class="section-title">Trail Resources</h2>
            <div class="resources-grid">
                <a href="https://bikenewengland.com/" target="_blank" class="resource-link">
                    <h3>üö¥ Bike New England</h3>
                    <p>1000+ routes with GPX files, cue sheets, and maps for all New England states.</p>
                </a>
                <a href="https://www.trailspotting.com/p/trailspotting-rail-trails.html" target="_blank" class="resource-link">
                    <h3>üó∫Ô∏è Trailspotting</h3>
                    <p>Complete rail trail maps with surface conditions and points of interest.</p>
                </a>
                <a href="https://www.railstotrails.org/" target="_blank" class="resource-link">
                    <h3>üõ§Ô∏è Rails-to-Trails Conservancy</h3>
                    <p>Official trail information and advocacy for rail trail conversion.</p>
                </a>
                <a href="https://www.greenway.org/" target="_blank" class="resource-link">
                    <h3>üåø East Coast Greenway</h3>
                    <p>3,000-mile trail from Maine to Florida. Many NE trails are part of this network.</p>
                </a>
            </div>
        </div>
    </section>

    <!-- Route Planner CTA -->
    <section class="section" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.2));">
        <div class="container" style="text-align: center;">
            <h2>üó∫Ô∏è Plan Your Own Route</h2>
            <p style="max-width: 600px; margin: 0 auto 1.5rem;">Use our route planner to create custom rides with bike-friendly directions, rail trails, and charging stations. Export to GPX for your GPS!</p>
            <a href="planner.html" class="btn btn-primary btn-large">Open Route Planner</a>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="section cta-section">
        <div class="container">
            <h2>Share Your Favorite Routes!</h2>
            <p>Know a great trail we missed? Join our community and share your discoveries with fellow riders.</p>
            <a href="https://www.facebook.com/groups/573295111141320/" target="_blank" class="btn btn-primary btn-large">Join Our Facebook Group</a>
        </div>
    </section>

    <!-- Trail List Modal -->
    <div class="trail-modal" id="trail-modal">
        <div class="trail-modal-content">
            <div class="trail-modal-header">
                <h2 id="modal-title">All Trails</h2>
                <button class="trail-modal-close" onclick="closeTrailModal()">&times;</button>
            </div>
            <div class="trail-list" id="modal-trail-list">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-logo">‚ö° New England E-Bike and PEV</span>
                    <p>A community for electric mobility enthusiasts in New England</p>
                </div>
                <div class="footer-links">
                    <a href="https://www.facebook.com/groups/573295111141320/" target="_blank">Facebook Group</a>
                    <a href="index.html">Home</a>
                    <a href="laws.html">Laws</a>
                    <a href="routes.html">Routes</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 New England E-Bike and PEV Community. Ride safe! ‚ö°</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script>
        // Initialize the map centered on New England
        const map = L.map('trail-map').setView([43.0, -71.5], 7);
        
        // Base map layers
        const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri, Maxar, Earthstar Geographics'
        });
        
        const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap contributors'
        });
        
        // Add default layer
        streetMap.addTo(map);
        
        // Layer control
        const baseMaps = {
            "üó∫Ô∏è Street": streetMap,
            "üõ∞Ô∏è Satellite": satellite,
            "‚õ∞Ô∏è Terrain": terrain
        };
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
        
        // Layer groups - use clustering for trails too
        const trailsLayer = L.markerClusterGroup({
            maxClusterRadius: 40,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 12,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div style="background:#10b981;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${count}</div>`,
                    className: 'trail-cluster',
                    iconSize: [36, 36]
                });
            }
        }).addTo(map);
        const chargingLayer = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 14
        });
        
        // Custom icons by state for trails
        function createTrailIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:12px;">üö¥</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
        }
        
        // Charging station icons
        function createChargingIcon(type) {
            const colors = {
                'J1772': '#f59e0b',
                'NEMA': '#10b981',
                'Other': '#6b7280'
            };
            const color = colors[type] || colors['Other'];
            return L.divIcon({
                className: 'charging-marker',
                html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:10px;">‚ö°</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }
        
        const trailIcons = {
            VT: createTrailIcon('#2ecc71'),
            NH: createTrailIcon('#9b59b6'),
            ME: createTrailIcon('#e74c3c'),
            MA: createTrailIcon('#3498db'),
            CT: createTrailIcon('#f39c12'),
            RI: createTrailIcon('#1abc9c')
        };
        
        // Trail data loaded from JSON
        let trailsData = [];
        
        // Create trail popup with navigation and info buttons
        function createTrailPopup(trail) {
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${trail.lat},${trail.lng}`;
            const ratingStars = trail.rating ? '‚≠ê'.repeat(Math.round(trail.rating)) : '';
            const isTopPick = trail.rating && trail.rating >= 4.5 && trail.length >= 10;
            
            return `
                <h3>${isTopPick ? 'üèÜ ' : ''}${trail.name}</h3>
                <p class="popup-distance">üìè ${trail.length} miles</p>
                <p><strong>Surface:</strong> ${trail.surface || 'Varies'}</p>
                ${trail.cities ? `<p><strong>Route:</strong> ${trail.cities}</p>` : ''}
                ${ratingStars ? `<p>${ratingStars} (${trail.rating})</p>` : ''}
                ${trail.description ? `<p style="font-size:0.85rem;margin-top:0.5rem;">${trail.description.substring(0, 120)}${trail.description.length > 120 ? '...' : ''}</p>` : ''}
                <div class="popup-buttons">
                    <a href="${navUrl}" target="_blank" class="popup-btn popup-btn-nav">üìç Navigate</a>
                    ${trail.url ? `<a href="${trail.url}" target="_blank" class="popup-btn popup-btn-web">üåê Info</a>` : ''}
                </div>
            `;
        }
        
        // Load trails from JSON database
        async function loadTrails() {
            try {
                const response = await fetch('data/rail_trails.json');
                const data = await response.json();
                trailsData = data.trails;
                
                console.log(`Loaded ${trailsData.length} trails`);
                document.getElementById('trail-count').textContent = trailsData.length;
                
                // Add markers to map
                trailsData.forEach(trail => {
                    if (!trail.lat || !trail.lng) return;
                    
                    const icon = trailIcons[trail.state] || trailIcons['MA'];
                    const marker = L.marker([trail.lat, trail.lng], { icon })
                        .bindPopup(createTrailPopup(trail));
                    trailsLayer.addLayer(marker);
                });
                
                // Generate trail cards
                generateTrailCards();
                
            } catch (error) {
                console.error('Error loading trails:', error);
            }
        }
        
        // Generate trail cards by state
        function generateTrailCards() {
            const states = {
                'CT': { name: 'Connecticut', emoji: 'üèõÔ∏è', container: document.querySelector('#connecticut .trail-cards') },
                'ME': { name: 'Maine', emoji: 'ü¶û', container: document.querySelector('#maine .trail-cards') },
                'MA': { name: 'Massachusetts', emoji: 'üèñÔ∏è', container: document.querySelector('#massachusetts .trail-cards') },
                'NH': { name: 'New Hampshire', emoji: '‚õ∞Ô∏è', container: document.querySelector('#new-hampshire .trail-cards') },
                'RI': { name: 'Rhode Island', emoji: 'üêö', container: document.querySelector('#rhode-island .trail-cards') },
                'VT': { name: 'Vermont', emoji: 'üèîÔ∏è', container: document.querySelector('#vermont .trail-cards') }
            };
            
            // Group trails by state and sort by rating/length
            Object.keys(states).forEach(stateCode => {
                const stateInfo = states[stateCode];
                if (!stateInfo.container) return;
                
                const stateTrails = trailsData
                    .filter(t => t.state === stateCode)
                    .sort((a, b) => {
                        // Sort by rating first, then by length
                        const ratingDiff = (b.rating || 0) - (a.rating || 0);
                        if (ratingDiff !== 0) return ratingDiff;
                        return (b.length || 0) - (a.length || 0);
                    })
                    .slice(0, 8); // Show top 8 per state
                
                // Clear existing cards
                stateInfo.container.innerHTML = '';
                
                // Generate cards
                stateTrails.forEach((trail, index) => {
                    const isTopPick = trail.rating && trail.rating >= 4.5 && trail.length >= 10;
                    const ratingStars = trail.rating ? '‚≠ê'.repeat(Math.round(trail.rating)) : '';
                    
                    const card = document.createElement('div');
                    card.className = `trail-card${isTopPick ? ' top-pick' : ''}`;
                    card.innerHTML = `
                        <h3>${trail.name}</h3>
                        <div class="trail-meta">
                            ${trail.cities ? `<span>üìç ${trail.cities}</span>` : ''}
                            <span>üìè ${trail.length} miles</span>
                            ${ratingStars ? `<span>${ratingStars}</span>` : ''}
                        </div>
                        <p>${trail.description || 'A scenic rail trail perfect for e-bike adventures.'}</p>
                        <div class="trail-tags">
                            ${trail.surface ? `<span class="trail-tag">üõ§Ô∏è ${trail.surface.split(',')[0]}</span>` : ''}
                            ${trail.length >= 20 ? '<span class="trail-tag">üö¥ Long Distance</span>' : ''}
                            ${trail.rating >= 4.5 ? '<span class="trail-tag">‚≠ê Highly Rated</span>' : ''}
                        </div>
                        <div style="margin-top: 1rem;">
                            <a href="${trail.url || '#'}" target="_blank" class="popup-btn popup-btn-web" style="text-decoration:none;">üåê Trail Info</a>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${trail.lat},${trail.lng}" target="_blank" class="popup-btn popup-btn-nav" style="text-decoration:none; margin-left: 0.5rem;">üìç Navigate</a>
                        </div>
                    `;
                    stateInfo.container.appendChild(card);
                });
                
                // Update state title with clickable count
                const sectionIdMap = {
                    'CT': 'connecticut',
                    'ME': 'maine', 
                    'MA': 'massachusetts',
                    'NH': 'new-hampshire',
                    'RI': 'rhode-island',
                    'VT': 'vermont'
                };
                const sectionId = sectionIdMap[stateCode];
                const titleEl = document.querySelector(`#${sectionId} .state-title`);
                if (titleEl) {
                    const totalInState = trailsData.filter(t => t.state === stateCode).length;
                    titleEl.innerHTML = `${stateInfo.emoji} ${stateInfo.name} <span class="trail-count-badge" onclick="openTrailModal('${stateCode}', '${stateInfo.name}')">${totalInState} trails ‚Üí</span>`;
                }
            });
        }
        
        // Modal functions
        function openTrailModal(stateCode, stateName) {
            const modal = document.getElementById('trail-modal');
            const title = document.getElementById('modal-title');
            const list = document.getElementById('modal-trail-list');
            
            // Get all trails for this state
            const stateTrails = trailsData
                .filter(t => t.state === stateCode)
                .sort((a, b) => {
                    const ratingDiff = (b.rating || 0) - (a.rating || 0);
                    if (ratingDiff !== 0) return ratingDiff;
                    return (b.length || 0) - (a.length || 0);
                });
            
            title.textContent = `All ${stateName} Trails (${stateTrails.length})`;
            
            // Generate list items
            list.innerHTML = stateTrails.map(trail => {
                const ratingStars = trail.rating ? '‚≠ê'.repeat(Math.round(trail.rating)) : '';
                return `
                    <div class="trail-list-item">
                        <span class="trail-list-name">${trail.name}</span>
                        <span class="trail-list-meta">
                            <span>üìè ${trail.length} mi</span>
                            ${ratingStars ? `<span>${ratingStars}</span>` : ''}
                        </span>
                        <div class="trail-list-actions">
                            ${trail.url ? `<a href="${trail.url}" target="_blank" class="btn-info">‚ÑπÔ∏è Info</a>` : ''}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${trail.lat},${trail.lng}" target="_blank" class="btn-nav">üìç Go</a>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeTrailModal() {
            document.getElementById('trail-modal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Close modal on escape key or click outside
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeTrailModal();
        });
        
        document.getElementById('trail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'trail-modal') closeTrailModal();
        });
        
        // Load trails on page load
        loadTrails();
        
        // Charging stations data and loading
        let chargingData = [];
        let chargingLoaded = false;
        
        async function loadChargingStations() {
            if (chargingLoaded) return;
            
            document.getElementById('map-loading').style.display = 'flex';
            
            try {
                const response = await fetch('data/charging_stations.json');
                const data = await response.json();
                chargingData = data.stations;
                
                document.getElementById('charging-count').textContent = chargingData.length.toLocaleString();
                
                // Add markers to cluster group
                chargingData.forEach(station => {
                    if (!station.lat || !station.lng) return;
                    
                    const popup = createChargingPopup(station);
                    const marker = L.marker([station.lat, station.lng], { 
                        icon: createChargingIcon(station.chargerType) 
                    }).bindPopup(popup);
                    
                    marker.stationType = station.chargerType;
                    chargingLayer.addLayer(marker);
                });
                
                chargingLoaded = true;
                console.log(`Loaded ${chargingData.length} charging stations`);
                
            } catch (error) {
                console.error('Error loading charging stations:', error);
                document.getElementById('charging-count').textContent = 'Error';
            }
            
            document.getElementById('map-loading').style.display = 'none';
        }
        
        // Create charging station popup
        function createChargingPopup(station) {
            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${station.lat},${station.lng}`;
            const typeClass = station.chargerType.toLowerCase();
            
            let connectorList = '';
            if (station.connectors && station.connectors.length) {
                connectorList = station.connectors.slice(0, 3).join(', ');
                if (station.connectors.length > 3) connectorList += '...';
            }
            
            return `
                <div class="charging-popup">
                    <h3>‚ö° ${station.name}</h3>
                    <span class="charging-type ${typeClass}">${station.chargerType}</span>
                    <p class="charging-info">üìç ${station.address}, ${station.city}</p>
                    ${station.hours ? `<p class="charging-info">üïê ${station.hours.substring(0, 50)}${station.hours.length > 50 ? '...' : ''}</p>` : ''}
                    ${station.pricing ? `<p class="charging-info">üí∞ ${station.pricing}</p>` : ''}
                    ${connectorList ? `<p class="charging-info">üîå ${connectorList}</p>` : ''}
                    <div class="popup-buttons">
                        <a href="${navUrl}" target="_blank" class="popup-btn popup-btn-nav">üìç Navigate</a>
                    </div>
                </div>
            `;
        }
        
        // Toggle handlers
        document.getElementById('toggle-trails').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(trailsLayer);
                this.parentElement.classList.add('active');
            } else {
                map.removeLayer(trailsLayer);
                this.parentElement.classList.remove('active');
            }
        });
        
        document.getElementById('toggle-charging').addEventListener('change', async function() {
            if (this.checked) {
                if (!chargingLoaded) {
                    await loadChargingStations();
                }
                map.addLayer(chargingLayer);
                this.parentElement.classList.add('active');
                // Show search box
                document.getElementById('search-container').style.display = 'block';
            } else {
                map.removeLayer(chargingLayer);
                this.parentElement.classList.remove('active');
                // Hide search box
                document.getElementById('search-container').style.display = 'none';
                clearSearch();
            }
        });
        
        // Geocoding helper - convert address to coordinates
        async function geocodeAddress(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=us`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
                }
            } catch (e) {
                console.error('Geocoding error:', e);
            }
            return null;
        }
        
        // Calculate distance between two points in miles
        function getDistanceMiles(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Check if query looks like an address
        function looksLikeAddress(query) {
            // Contains numbers + words, or contains common address terms
            return /\d+\s+\w+/.test(query) || 
                   /\b(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd|way|court|ct|place|pl)\b/i.test(query) ||
                   /\b(maine|me|massachusetts|ma|new hampshire|nh|vermont|vt|connecticut|ct|rhode island|ri)\b/i.test(query);
        }
        
        // Search functionality
        let searchMarkers = L.layerGroup();
        
        async function searchCharging() {
            const query = document.getElementById('charging-search').value.trim();
            if (!query || !chargingLoaded) return;
            
            // Clear previous search results
            searchMarkers.clearLayers();
            map.removeLayer(searchMarkers);
            
            let matches = [];
            let resultText = '';
            
            // Check if it looks like an address - try geocoding first
            if (looksLikeAddress(query)) {
                document.getElementById('search-results').textContent = 'Searching location...';
                const location = await geocodeAddress(query);
                
                if (location) {
                    // Find chargers within 15 miles of the address
                    const radius = 15;
                    matches = chargingData
                        .map(station => ({
                            ...station,
                            distance: getDistanceMiles(location.lat, location.lng, station.lat, station.lng)
                        }))
                        .filter(s => s.distance <= radius)
                        .sort((a, b) => a.distance - b.distance);
                    
                    resultText = matches.length > 0 
                        ? `Found ${matches.length} charging stations within ${radius} miles of "${query.split(',')[0]}"`
                        : `No charging stations within ${radius} miles of "${query}"`;
                    
                    // Add location marker
                    const locMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            html: `<div style="background:#3b82f6;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:16px;">üìç</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).bindPopup(`<strong>Your search location</strong><br>${location.name.split(',').slice(0,3).join(',')}`);
                    searchMarkers.addLayer(locMarker);
                }
            }
            
            // If no location matches or not an address, search by text
            if (matches.length === 0) {
                matches = chargingData.filter(station => {
                    const searchText = `${station.name} ${station.city} ${station.address} ${station.state}`.toLowerCase();
                    return searchText.includes(query.toLowerCase());
                });
                resultText = matches.length > 0 
                    ? `Found ${matches.length} stations matching "${query}"`
                    : `No stations found for "${query}"`;
            }
            
            // Show results
            document.getElementById('search-results').textContent = resultText;
            document.getElementById('clear-search').style.display = matches.length > 0 ? 'inline-block' : 'none';
            
            if (matches.length === 0) return;
            
            // Add markers for matches with highlighted style
            const bounds = L.latLngBounds();
            matches.slice(0, 100).forEach(station => {
                if (!station.lat || !station.lng) return;
                
                const distText = station.distance ? ` (${station.distance.toFixed(1)} mi)` : '';
                const highlightIcon = L.divIcon({
                    className: 'search-result-marker',
                    html: `<div style="background:#ef4444;width:26px;height:26px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #ef4444;display:flex;align-items:center;justify-content:center;font-size:12px;animation:pulse 1s infinite;">‚ö°</div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13],
                    popupAnchor: [0, -13]
                });
                
                const marker = L.marker([station.lat, station.lng], { icon: highlightIcon })
                    .bindPopup(createChargingPopup(station) + (distText ? `<p style="color:#10b981;font-weight:bold;">${distText}</p>` : ''));
                searchMarkers.addLayer(marker);
                bounds.extend([station.lat, station.lng]);
            });
            
            map.addLayer(searchMarkers);
            
            // Zoom to results if we have them
            if (matches.length > 0 && matches.length <= 50) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
            }
        }
        
        function clearSearch() {
            document.getElementById('charging-search').value = '';
            document.getElementById('search-results').textContent = '';
            document.getElementById('clear-search').style.display = 'none';
            searchMarkers.clearLayers();
            map.removeLayer(searchMarkers);
        }
        
        // Search event listeners
        document.getElementById('search-btn').addEventListener('click', searchCharging);
        document.getElementById('charging-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCharging();
        });
        document.getElementById('clear-search').addEventListener('click', clearSearch);
        
        // Trail search functionality
        let trailSearchMarkers = L.layerGroup();
        
        async function searchTrails() {
            const query = document.getElementById('trail-search').value.trim();
            if (!query || trailsData.length === 0) return;
            
            // Clear previous search results
            trailSearchMarkers.clearLayers();
            map.removeLayer(trailSearchMarkers);
            
            let matches = [];
            let resultText = '';
            
            // Check if it looks like an address - try geocoding first
            if (looksLikeAddress(query)) {
                document.getElementById('trail-search-results').textContent = 'Searching location...';
                const location = await geocodeAddress(query);
                
                if (location) {
                    // Find trails within 25 miles of the address
                    const radius = 25;
                    matches = trailsData
                        .filter(t => t.lat && t.lng)
                        .map(trail => ({
                            ...trail,
                            distance: getDistanceMiles(location.lat, location.lng, trail.lat, trail.lng)
                        }))
                        .filter(t => t.distance <= radius)
                        .sort((a, b) => a.distance - b.distance);
                    
                    resultText = matches.length > 0 
                        ? `Found ${matches.length} trails within ${radius} miles of "${query.split(',')[0]}"`
                        : `No trails within ${radius} miles of "${query}"`;
                    
                    // Add location marker
                    const locMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            html: `<div style="background:#3b82f6;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:16px;">üìç</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).bindPopup(`<strong>Your search location</strong><br>${location.name.split(',').slice(0,3).join(',')}`);
                    trailSearchMarkers.addLayer(locMarker);
                }
            }
            
            // If no location matches or not an address, search by text
            if (matches.length === 0) {
                matches = trailsData.filter(trail => {
                    const searchText = `${trail.name} ${trail.cities || ''} ${trail.state} ${trail.description || ''}`.toLowerCase();
                    return searchText.includes(query.toLowerCase());
                });
                resultText = matches.length > 0 
                    ? `Found ${matches.length} trails matching "${query}"`
                    : `No trails found for "${query}"`;
            }
            
            // Show results
            document.getElementById('trail-search-results').textContent = resultText;
            document.getElementById('trail-clear-search').style.display = matches.length > 0 ? 'inline-block' : 'none';
            
            if (matches.length === 0) return;
            
            // Add highlighted markers for matches
            const bounds = L.latLngBounds();
            matches.forEach(trail => {
                if (!trail.lat || !trail.lng) return;
                
                const distText = trail.distance ? ` (${trail.distance.toFixed(1)} mi away)` : '';
                const highlightIcon = L.divIcon({
                    className: 'trail-search-result',
                    html: `<div style="background:#10b981;width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 0 12px #10b981;display:flex;align-items:center;justify-content:center;font-size:14px;animation:pulse 1s infinite;">üö¥</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14],
                    popupAnchor: [0, -14]
                });
                
                const marker = L.marker([trail.lat, trail.lng], { icon: highlightIcon })
                    .bindPopup(createTrailPopup(trail) + (distText ? `<p style="color:#10b981;font-weight:bold;margin-top:0.5rem;">üìç${distText}</p>` : ''));
                trailSearchMarkers.addLayer(marker);
                bounds.extend([trail.lat, trail.lng]);
            });
            
            map.addLayer(trailSearchMarkers);
            
            // Zoom to results
            if (matches.length > 0 && matches.length <= 50) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 11 });
            }
        }
        
        function clearTrailSearch() {
            document.getElementById('trail-search').value = '';
            document.getElementById('trail-search-results').textContent = '';
            document.getElementById('trail-clear-search').style.display = 'none';
            trailSearchMarkers.clearLayers();
            map.removeLayer(trailSearchMarkers);
        }
        
        // Trail search event listeners
        document.getElementById('trail-search-btn').addEventListener('click', searchTrails);
        document.getElementById('trail-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchTrails();
        });
        document.getElementById('trail-clear-search').addEventListener('click', clearTrailSearch);
        
        // Mobile nav toggle
        const navToggle = document.querySelector('.nav-toggle');
        const navLinks = document.querySelector('.nav-links');
        
        navToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            navToggle.classList.toggle('active');
        });
    </script>
    
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
<script src="analytics.js"></script>
</body>
</html>
